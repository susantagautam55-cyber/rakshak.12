<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Patient Accident Demo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .message-box {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 1.5rem;
            border-radius: 0.75rem;
            box-shadow: 0 10px 15px -3px rgba(135, 221, 247, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            z-index: 1000;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen flex flex-col items-center justify-center p-8">

    <script>
        let crashThreshold = 25;
        let lastSent = 0;
        const statusElement = document.getElementById("status");
        const startButton = document.getElementById("startButton");
        const messageBox = document.getElementById('messageBox');
        const messageText = document.getElementById('messageText');
        const closeMessageButton = document.getElementById('closeMessage');
        let userProfileData = JSON.parse(localStorage.getItem("rakshakUser"));
        
        document.addEventListener("DOMContentLoaded", () => {
            if (!userProfileData) {
                statusElement.textContent = "Please sign in to use the sensor.";
                startButton.disabled = true;
                return;
            }
            if (userProfileData.userType === "doctor") {
                statusElement.textContent = "This device is for patient use. Please switch accounts.";
                startButton.disabled = true;
                return;
            }

            statusElement.textContent = `Ready to monitor for ${userProfileData.fullName}.`;
            startButton.disabled = false;

            document.getElementById('closeMessage').addEventListener('click', hideMessage);
            window.startSensors = startSensors;
            window.logout = logout;
        });

        const showMessage = (message, isSuccess = true) => {
            messageText.textContent = message;
            messageBox.classList.toggle('bg-green-100', isSuccess);
            messageBox.classList.toggle('text-green-800', isSuccess);
            messageBox.classList.toggle('bg-red-100', !isSuccess);
            messageBox.classList.toggle('text-red-800', !isSuccess);
            messageBox.style.display = 'block';
        };

        const hideMessage = () => {
            messageBox.style.display = 'none';
        };

        function startSensors() {
            if (window.DeviceMotionEvent) {
                window.addEventListener("devicemotion", handleMotion);
                document.getElementById("status").innerText = "Monitoring started...";
                showMessage("Monitoring your device for accidents.", true);
                document.getElementById("startButton").textContent = "Monitoring...";
                document.getElementById("startButton").disabled = true;
                document.getElementById("startButton").classList.add("opacity-50", "cursor-not-allowed");
            } else {
                showMessage("DeviceMotion is not supported on this device!", false);
            }
        }

        function handleMotion(event) {
            const ax = event.acceleration.x || 0;
            const ay = event.acceleration.y || 0;
            const az = event.acceleration.z || 0;
            const a_res = Math.sqrt(ax*ax + ay*ay + az*az);

            if (a_res > crashThreshold && Date.now() - lastSent > 10000) {
                lastSent = Date.now();
                sendSOS(ax, ay, az, a_res);
            }
        }

        async function sendSOS(ax, ay, az, a_res) {
            if (!userProfileData) {
                showMessage("User profile not loaded. Please sign up or reload.", false);
                return;
            }

            if ("geolocation" in navigator) {
                navigator.geolocation.getCurrentPosition(async pos => {
                    const sosData = {
                        fullName: userProfileData.fullName,
                        contact: userProfileData.contact,
                        emergencyContact: userProfileData.emergencyContact,
                        bloodGroup: userProfileData.bloodGroup,
                        location: {
                            lat: pos.coords.latitude,
                            lng: pos.coords.longitude
                        },
                        reportDetails: `SOS detected! A crash was detected by the device sensors. Acceleration: ${a_res.toFixed(2)} m/sÂ²`,
                        timestamp: new Date().toISOString()
                    };

                    try {
                        const response = await fetch('/api/sos', {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify(sosData)
                        });
                        const result = await response.json();
                        
                        if (result.received) {
                            document.getElementById("status").innerText = "SOS Sent! A doctor has been notified.";
                            showMessage("SOS alert sent successfully!", true);
                        } else {
                            document.getElementById("status").innerText = "Failed to send SOS!";
                            showMessage("An error occurred. Could not send SOS.", false);
                        }
                    } catch (error) {
                        console.error("Error sending SOS:", error);
                        document.getElementById("status").innerText = "Failed to connect to server!";
                        showMessage("Failed to connect to the server. Please check your network.", false);
                    }
                }, error => {
                    showMessage("Could not get location. Please allow location access.", false);
                    console.error("Geolocation error:", error);
                });
            } else {
                showMessage("Geolocation is not supported by your browser.", false);
            }
        }
        
        function logout() {
            localStorage.removeItem("rakshakUser");
            window.location.href = "signin.html";
        }
    </script>

    <nav class="flex justify-between items-center p-4 bg-blue-600 text-white w-full max-w-xl rounded-t-3xl shadow-xl z-20">
        <h1 class="text-xl font-bold">Rakshak Sensor</h1>
        <button onclick="logout()" class="px-3 py-1 bg-white text-blue-600 rounded-full hover:bg-gray-200">Logout</button>
    </nav>
    
    <div class="w-full max-w-xl bg-white rounded-b-3xl shadow-2xl p-8 md:p-12 text-center">
        <h2 class="text-3xl font-bold text-gray-800 mb-4">Patient Device</h2>
        <p class="text-gray-600 mb-6">Click "Start Monitoring" to simulate a sensor detecting motion or a crash.</p>
        <button id="startButton" onclick="startSensors()" class="px-6 py-3 bg-green-600 text-white rounded-lg shadow-lg hover:bg-green-700 transition-transform transform active:scale-95 focus:outline-none focus:ring-4 focus:ring-green-300">Start Monitoring</button>
        <p id="status" class="mt-4 text-gray-700 font-semibold">Waiting...</p>
    </div>

    <div id="messageBox" class="message-box bg-white text-gray-800">
        <p id="messageText" class="text-center font-semibold"></p>
        <button id="closeMessage" class="absolute top-2 right-2 text-gray-500 hover:text-gray-700">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
            </svg>
        </button>
    </div>
</body>
</html>
