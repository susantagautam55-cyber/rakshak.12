<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Patient Accident Demo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .message-box {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 1.5rem;
            border-radius: 0.75rem;
            box-shadow: 0 10px 15px -3px rgba(135, 221, 247, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            z-index: 1000;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen flex flex-col items-center justify-center p-8">

    <nav class="flex justify-between items-center p-4 bg-blue-600 text-white w-full max-w-xl rounded-t-3xl shadow-xl z-20">
        <h1 class="text-xl font-bold">Rakshak Sensor</h1>
        <button onclick="logout()" class="px-3 py-1 bg-white text-blue-600 rounded-full hover:bg-gray-200">Logout</button>
    </nav>
    
    <div class="w-full max-w-xl bg-white rounded-b-3xl shadow-2xl p-8 md:p-12 text-center">
        <h2 class="text-3xl font-bold text-gray-800 mb-4">Patient Device</h2>
        <p class="text-gray-600 mb-6">Click "Start Monitoring" to simulate a sensor detecting motion or a crash.</p>
        <button id="startButton" onclick="startSensors()" class="px-6 py-3 bg-green-600 text-white rounded-lg shadow-lg hover:bg-green-700 transition-transform transform active:scale-95 focus:outline-none focus:ring-4 focus:ring-green-300">Start Monitoring</button>
        <p id="status" class="mt-4 text-gray-700 font-semibold">Waiting...</p>
    </div>

    <div id="messageBox" class="message-box bg-white text-gray-800">
        <p id="messageText" class="text-center font-semibold"></p>
        <button id="closeMessage" class="absolute top-2 right-2 text-gray-500 hover:text-gray-700">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
            </svg>
        </button>
    </div>
    
    <script>
         const socket = new WebSocket("ws://YOUR_LAPTOP_IP:192.168.1.6");
        document.addEventListener("DOMContentLoaded", () => {
            const serverUrl = "http://localhost:3000/api/sos";
            let crashThreshold = 25;
            let lastSent = 0;
            const statusElement = document.getElementById("status");
            const startButton = document.getElementById("startButton");
            const messageBox = document.getElementById('messageBox');
            const messageText = document.getElementById('messageText');
            const closeMessageButton = document.getElementById('closeMessage');
            
            const user = JSON.parse(localStorage.getItem("rakshakUser"));

            if (!user) {
                statusElement.textContent = "Please log in to use the sensor.";
                startButton.disabled = true;
                return;
            }

            const showMessage = (message, isSuccess = true) => {
                messageText.textContent = message;
                messageBox.classList.toggle('bg-green-100', isSuccess);
                messageBox.classList.toggle('text-green-800', isSuccess);
                messageBox.classList.toggle('bg-red-100', !isSuccess);
                messageBox.classList.toggle('text-red-800', !isSuccess);
                messageBox.style.display = 'block';
            };

            const hideMessage = () => {
                messageBox.style.display = 'none';
            };
            closeMessageButton.addEventListener('click', hideMessage);

            function startSensors() {
                if (window.DeviceMotionEvent) {
                    window.addEventListener("devicemotion", handleMotion);
                    statusElement.innerText = "Monitoring started...";
                    showMessage("Monitoring your device for accidents.", true);
                    startButton.textContent = "Monitoring...";
                    startButton.disabled = true;
                    startButton.classList.add("opacity-50", "cursor-not-allowed");
                } else {
                    showMessage("DeviceMotion not supported!", false);
                }
            }

            function handleMotion(event) {
                const ax = event.acceleration.x || 0;
                const ay = event.acceleration.y || 0;
                const az = event.acceleration.z || 0;
                const a_res = Math.sqrt(ax*ax + ay*ay + az*az);

                if (a_res > crashThreshold && Date.now() - lastSent > 10000) {
                    lastSent = Date.now();
                    sendSOS(ax, ay, az, a_res);
                }
            }

            function sendSOS(ax, ay, az, a_res) {
                navigator.geolocation.getCurrentPosition(pos => {
                    const data = {
                        fullName: user.fullName,
                        contact: user.contact,
                        emergencyContact: user.emergencyContact,
                        bloodGroup: user.bloodGroup,
                        latitude: pos.coords.latitude,
                        longitude: pos.coords.longitude,
                        speed: pos.coords.speed,
                        accel: { ax, ay, az, a_res },
                        event: "CRASH_DETECTED"
                    };

                    fetch(serverUrl, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(data)
                    })
                    .then(r => r.json())
                    .then(res => {
                        statusElement.innerText = "SOS Sent! A doctor has been notified.";
                        showMessage("SOS alert sent successfully!", true);
                        console.log(res);
                    })
                    .catch(error => {
                        statusElement.innerText = "Failed to send SOS!";
                        showMessage("An error occurred. Could not send SOS.", false);
                        console.error("Error sending SOS:", error);
                    });
                }, error => {
                    showMessage("Could not get location. Please allow location access.", false);
                    console.error("Geolocation error:", error);
                });
            }
        });
        
        function logout() {
            localStorage.removeItem("rakshakUser");
            window.location.href = "signin.html";
        }
    </script>
</body>
</html>